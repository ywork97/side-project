<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>유튜브 채팅 커스터마이징</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin-bottom: 50px;
    }
    .chat-container {
      max-height: 730px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 50px;
      /* 채팅창 영역 조정 기능 추가 */
      resize: vertical;
    }
    .chat-message {
      padding: 5px;
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      position: relative;
      font-size: 14px;
    }
    .chat-message:hover {
      background-color: #f9f9f9;
    }
    /* 강조 키워드 */
    .highlight {
      background-color: #fff3cd;
    }
    /* 닉네임 강조 */
    .nickname-highlight {
      background-color: #d8fcd8;
    }
    /* 뱃지 강조 */
    .badge-highlight {
      background-color: orange;
    }
    .context-menu {
      position: absolute;
      display: none;
      background-color: #fff;
      border: 1px solid #ddd;
      z-index: 1000;
      border-radius: 3px;
    }
    .context-menu button {
      border: none;
      background: none;
      padding: 5px 10px;
      width: 100%;
      text-align: left;
    }
    .context-menu button:hover {
      background-color: #eee;
    }
    .card-header a {
      text-decoration: none;
      color: #007bff;
    }
    .card-header a:hover {
      color: #0056b3;
    }
    .chat-badges img {
      width: 16px;
      height: 16px;
      margin-right: 4px;
      vertical-align: middle;
    }
    .chat-badges span.badge-title {
      margin-right: 4px;
      font-size: 12px;
      color: #666;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="card mb-3">
    <div class="card-header">
      <a data-toggle="collapse" href="#collapseSettings" role="button" aria-expanded="false" aria-controls="collapseSettings">
        ▼ 설정 접기/펼치기
      </a>
    </div>
    <div class="collapse" id="collapseSettings">
      <div class="card-body">
        <!-- 채팅 URL 및 수집 시작/중단 -->
        <div class="mb-3">
          <label for="chatUrl">유튜브 채팅 URL:</label>
          <div class="input-group">
            <input type="text" id="chatUrl" class="form-control" placeholder="유튜브 채팅 URL 입력">
            <div class="input-group-append">
              <button id="startChat" class="btn btn-primary">채팅 수집 시작</button>
              <button id="stopChat" class="btn btn-danger">채팅 수집 중단</button>
            </div>
          </div>
        </div>
        <!-- 검색 기능 -->
        <div class="mb-3">
          <label for="exceptionKeywords">예외 키워드 (콤마로 구분):</label>
          <input type="text" id="exceptionKeywords" class="form-control" placeholder="예: 스팸, 광고">
        </div>
        <div class="mb-3">
          <label for="highlightKeywords">강조 키워드 (콤마로 구분):</label>
          <input type="text" id="highlightKeywords" class="form-control" placeholder="예: 중요, 공지">
        </div>
        <div class="mb-3">
          <label for="nicknameHighlights">닉네임 강조 (콤마로 구분):</label>
          <input type="text" id="nicknameHighlights" class="form-control" placeholder="예: 홍길동, JohnDoe">
        </div>
        <div class="mb-3">
          <label for="fontSizeRange">폰트 크기: </label>
          <input type="range" id="fontSizeRange" min="10" max="24" step="1" value="20">
          <span id="fontSizeValue">20px</span>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-3">
    <label for="searchInput">채팅 검색 (닉네임 또는 내용):</label>
    <div class="input-group">
      <input type="text" id="searchInput" class="form-control" placeholder="검색어 입력">
      <div class="input-group-append">
        <button id="searchButton" class="btn btn-info">검색</button>
      </div>
    </div>
  </div>
  <div class="chat-container" id="chatContainer"></div>
</div>
<button id="scrollToBottom" class="btn btn-secondary" style="display: none; position: fixed; right: 20px; bottom: 20px;">
    ▼   
</button>
<div class="context-menu" id="contextMenu">
  <button id="deleteMessage">삭제</button>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
  let exceptionKeywords = [];
  let highlightKeywords = [];
  let nicknameHighlights = [];
  
  let pollingInterval = null;
  let currentContextTarget = null;
  let autoScroll = true;
  
  // 우클릭 시 대상 메시지에 data-id를 설정하여 삭제 시 사용
  $('#chatContainer').on('contextmenu', '.chat-message', function(e) {
      e.preventDefault(); // 기본 우클릭 메뉴 방지
      currentContextTarget = $(this); // 현재 우클릭한 요소 저장

      // 컨텍스트 메뉴 위치 조정 및 표시
      $('#contextMenu').css({
          top: e.pageY + 'px',
          left: e.pageX + 'px',
          display: 'block'
      });
  });

  // 삭제 버튼 클릭 시 해당 메시지 삭제 (data-id 기준으로 삭제)
  $('#deleteMessage').on('click', function() {
      if (currentContextTarget) {
          let msgId = currentContextTarget.data('id');
          $("#chatContainer").find(`[data-id='${msgId}']`).remove();
          currentContextTarget = null;
          $('#contextMenu').hide();
      }
  });

  // 문서 클릭 시 컨텍스트 메뉴 숨김
  $(document).on('click', function(e) {
      if (!$(e.target).closest('#contextMenu').length) {
          $('#contextMenu').hide();
      }
  });
  
  // 모든 채팅 메시지를 저장 (검색 필터링을 위해)
  let allMessages = [];
  
  function loadFromLocalStorage() {
    let ex = localStorage.getItem('exceptionKeywords');
    let hl = localStorage.getItem('highlightKeywords');
    let nh = localStorage.getItem('nicknameHighlights');
    if (ex !== null) { $('#exceptionKeywords').val(ex); }
    if (hl !== null) { $('#highlightKeywords').val(hl); }
    if (nh !== null) { $('#nicknameHighlights').val(nh); }
  }
  
  function saveToLocalStorage() {
    localStorage.setItem('exceptionKeywords', $('#exceptionKeywords').val());
    localStorage.setItem('highlightKeywords', $('#highlightKeywords').val());
    localStorage.setItem('nicknameHighlights', $('#nicknameHighlights').val());
  }
  
  function updateFilters() {
    let ex = $('#exceptionKeywords').val() || '';
    exceptionKeywords = ex.split(',').map(k => k.trim()).filter(k => k.length > 0);
    let hl = $('#highlightKeywords').val() || '';
    highlightKeywords = hl.split(',').map(k => k.trim()).filter(k => k.length > 0);
    let nh = $('#nicknameHighlights').val() || '';
    nicknameHighlights = nh.split(',').map(k => k.trim()).filter(k => k.length > 0);
    saveToLocalStorage();
    // 기존 메시지에도 적용
    recheckAllMessages();
  }
  
  // 이미 표시된 메시지 재검사 (예외, 강조 등)
  function recheckAllMessages() {
    $('.chat-message').each(function() {
      const $msgDiv = $(this);
      const messageText = $msgDiv.find('.chat-text').text().toLowerCase();
      const authorName = $msgDiv.find('.chat-name').text().toLowerCase();
  
      // 예외 키워드
      let isException = exceptionKeywords.some(kw => messageText.includes(kw.toLowerCase()));
      if (isException) { $msgDiv.hide(); return; } else { $msgDiv.show(); }
  
      // 강조 키워드
      let isHighlight = highlightKeywords.some(kw => messageText.includes(kw.toLowerCase()));
      if (isHighlight) { $msgDiv.addClass('highlight'); } else { $msgDiv.removeClass('highlight'); }
  
      // 닉네임 강조
      let isNicknameHighlight = nicknameHighlights.some(nm => authorName.includes(nm.toLowerCase()));
      if (isNicknameHighlight) { $msgDiv.addClass('nickname-highlight'); } else { $msgDiv.removeClass('nickname-highlight'); }
  
      // 뱃지 강조
      let badgesData = $msgDiv.data('badges');
      if (badgesData && badgesData.length > 0) {
        $msgDiv.addClass('badge-highlight');
      } else {
        $msgDiv.removeClass('badge-highlight');
      }
    });
  }
  
  // 개별 채팅 메시지 생성 함수 (두 번째 인자 reRender가 true이면 새 메시지 효과 없이 바로 렌더링)
  function createChatMessageElement(msg, reRender = false) {
    // 현재 설정된 폰트 사이즈 가져오기
    let fontSize = $('#fontSizeRange').val() + 'px';
    
    let msgDiv = $('<div class="chat-message"></div>');
    msgDiv.css('font-size', fontSize);
    msgDiv.data('badges', msg.badges);
    msgDiv.attr('data-id', msg.id); // 메시지 고유 id 설정
  
    // 예외 키워드 검사 (검색 기능과 별개로, 예외 키워드가 있으면 아예 표시하지 않음)
    for (let kw of exceptionKeywords) {
      if (msg.message && msg.message.toLowerCase().includes(kw.toLowerCase())) {
        return null;
      }
    }
  
    // 강조 키워드
    let highlight = highlightKeywords.some(kw => msg.message && msg.message.toLowerCase().includes(kw.toLowerCase()));
    if (highlight) { msgDiv.addClass('highlight'); }
  
    // 닉네임 강조
    let isNicknameHighlight = nicknameHighlights.some(nm => msg.author.toLowerCase().includes(nm.toLowerCase()));
    if (isNicknameHighlight) { msgDiv.addClass('nickname-highlight'); }
  
    // 뱃지 강조
    if (msg.badges && msg.badges.length > 0) {
      msgDiv.addClass('badge-highlight');
    }
  
    // 이미지/닉네임/메시지 표시 (이미지는 32x32로 고정)
    let icon = $('<img>')
      .attr('src', msg.image_url)
      .attr('width', 32)
      .attr('height', 32)
      .css({
        'border-radius': '50%',
        'margin-right': '10px',
        'object-fit': 'cover'
      });
  
    let name = $('<strong class="chat-name"></strong>').text(msg.author);
    let badgeContainer = $('<span class="chat-badges"></span>');
  
    if (msg.badges && msg.badges.length > 0) {
      msg.badges.forEach(badge => {
        if (badge.url) {
          let badgeImg = $('<img>').attr('src', badge.url);
          badgeContainer.append(badgeImg);
        } else {
          let badgeText = $('<span class="badge-title"></span>').text(badge.title);
          badgeContainer.append(badgeText);
        }
      });
    }
  
    let text = $('<span class="chat-text"></span>').text(': ' + msg.message);
  
    msgDiv.append(icon, badgeContainer, name, text);
    if (!reRender) {
      // 새 메시지인 경우 부드러운 효과를 위해 초기 display를 none으로 설정
      msgDiv.css('display', 'none');
    }
    return msgDiv;
  }
  
  // 채팅창 업데이트 함수 (검색어 필터링 적용)
  function updateChatDisplay() {
    let searchQuery = $('#searchInput').val().trim().toLowerCase();
    $('#chatContainer').empty();
    allMessages.forEach(msg => {
      // 검색창이 공란이면 전체 메시지, 아니면 닉네임 또는 메시지 내용에 검색어 포함 여부 필터링
      if (searchQuery === "" || 
          (msg.author && msg.author.toLowerCase().includes(searchQuery)) ||
          (msg.message && msg.message.toLowerCase().includes(searchQuery))) {
        let msgElem = createChatMessageElement(msg, true);
        if (msgElem !== null) {
          $('#chatContainer').append(msgElem);
        }
      }
    });
  }
  
  // 새 메시지 표시 함수: 새로운 메시지는 fadeIn 효과로 추가하며, autoScroll 여부에 따라 스크롤 처리
  function processNewMessages(newMsgs) {
    newMsgs.forEach(function(msg) {
      allMessages.push(msg);
      // 검색 중이 아니면 개별적으로 메시지 추가
      if($('#searchInput').val().trim() === "") {
         let msgElem = createChatMessageElement(msg, false);
         if(msgElem !== null){
             $('#chatContainer').append(msgElem);
             msgElem.fadeIn(500);
         }
      }
    });
    if($('#searchInput').val().trim() !== ""){
      updateChatDisplay();
    }
    let chatContainer = $('#chatContainer');
    if(autoScroll){
      chatContainer.animate({ scrollTop: chatContainer[0].scrollHeight }, 500);
      $('#scrollToBottom').hide();
    } else {
      $('#scrollToBottom').show();
    }
  }
  
  function pollMessages() {
    $.getJSON('/get_messages', function(data) {
      if (data && data.length > 0) {
        processNewMessages(data);
      }
    });
  }
  
  // 채팅 수집 시작 버튼 클릭 이벤트
  $('#startChat').on('click', function(){
    let url = $('#chatUrl').val().trim();
    if (!url) {
      alert('유튜브 채팅 URL을 입력하세요.');
      return;
    }
    $.post('/start', {url: url}, function(response) {
      if(response.status === 'started') {
        // 3시간 후 자동 중단 트리거
        setTimeout(function(){
          $.post('/stop', function(resp){
            alert("채팅 수집이 자동으로 중단되었습니다. (3시간 경과)");
            if (pollingInterval) {
              clearInterval(pollingInterval);
              pollingInterval = null;
            }
          });
        }, 3 * 3600 * 1000);
  
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(pollMessages, 1000);
      }
    });
  });
  
  // 채팅 수집 중단 버튼 클릭 이벤트
  $('#stopChat').on('click', function(){
    $.post('/stop', function(response) {
      if(response.status === 'stopped') {
        alert("채팅 수집이 중단되었습니다.");
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
      }
    });
  });
  
  // 검색 버튼 클릭 시 채팅창 업데이트
  $('#searchButton').on('click', function(){
    updateChatDisplay();
  });
  
  // 검색 입력창 엔터키 이벤트 처리 (엔터 누르면 검색 실행)
  $('#searchInput').on('keypress', function(e) {
    if (e.which === 13) {
      updateChatDisplay();
    }
  });
  
  // 예외/강조/닉네임 입력 시 업데이트
  $('#exceptionKeywords, #highlightKeywords, #nicknameHighlights').on('input', function(){
    updateFilters();
  });
  
  // 폰트 사이즈 조절 (기존 메시지에도 적용)
  $('#fontSizeRange').on('input', function() {
    let fontSize = $(this).val() + 'px';
    $('#fontSizeValue').text(fontSize);
    $('.chat-message').css('font-size', fontSize);
  });
  
  // 스크롤 이벤트 처리: 사용자가 스크롤을 위로 올리면 autoScroll off, 최하단이면 on
  let chatContainer = $('#chatContainer');
  chatContainer.on('scroll', function() {
    let scrollTop = chatContainer.scrollTop();
    let scrollHeight = chatContainer[0].scrollHeight;
    let clientHeight = chatContainer[0].clientHeight;
    if (scrollTop + clientHeight < scrollHeight - 10) {
       autoScroll = false;
       $('#scrollToBottom').show();
    } else {
       autoScroll = true;
       $('#scrollToBottom').hide();
    }
  });
  
  // "맨 아래로 이동" 버튼 클릭 시 부드러운 스크롤 애니메이션과 함께 autoScroll on
  $('#scrollToBottom').on('click', function(){
      chatContainer.animate({ scrollTop: chatContainer[0].scrollHeight }, 500, function(){
         autoScroll = true;
         $('#scrollToBottom').hide();
      });
  });
  
  // 페이지 로드 시
  $(document).ready(function() {
    loadFromLocalStorage();
    updateFilters();
  });
</script>
</body>
</html>
